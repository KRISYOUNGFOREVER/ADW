# AI设计平台功能模块文档

## 1. 模块概览

### 1.1 模块架构图

```
┌─────────────────┐    ┌─────────────────┐
│   前端交互模块   │    │   后端服务模块   │
├─────────────────┤    ├─────────────────┤
│ 工作流式交互     │    │ Dify工作流引擎   │
│ 聊天式交互       │    │ MCP服务集群      │
└─────────────────┘    └─────────────────┘
         │                       │
         └───────────┬───────────┘
                     │
         ┌─────────────────┐
         │   核心业务模块   │
         ├─────────────────┤
         │ 需求分析模块     │
         │ 任务管理模块     │
         │ 设计执行模块     │
         │ 质量控制模块     │
         └─────────────────┘
```

## 2. 前端交互模块

### 2.1 工作流式交互模块

#### 2.1.1 模块职责
- 提供步骤化的设计流程界面
- 展示每个步骤的执行状态和结果
- 支持用户在每个步骤进行确认和修改
- 管理整个设计流程的进度

#### 2.1.2 核心功能
- **流程导航**: 显示当前步骤和整体进度
- **步骤执行**: 触发每个设计步骤的执行
- **结果预览**: 展示每步的设计结果
- **用户确认**: 等待用户确认或提出修改意见
- **流程控制**: 支持暂停、继续、重新执行

#### 2.1.3 接口定义
```typescript
interface WorkflowInterface {
  // 启动工作流
  startWorkflow(requirements: string): Promise<WorkflowSession>
  
  // 获取当前步骤状态
  getCurrentStep(sessionId: string): Promise<StepStatus>
  
  // 确认当前步骤
  confirmStep(sessionId: string, feedback?: string): Promise<void>
  
  // 重新执行步骤
  retryStep(sessionId: string, modifications?: any): Promise<void>
  
  // 获取最终结果
  getFinalResult(sessionId: string): Promise<DesignResult>
}
```

### 2.2 聊天式交互模块

#### 2.2.1 模块职责
- 提供自然语言交互界面
- 理解用户的设计需求和反馈
- 展示AI的分析过程和执行结果
- 支持多轮对话和需求细化

#### 2.2.2 核心功能
- **对话管理**: 维护对话历史和上下文
- **需求理解**: 解析用户的自然语言需求
- **进度展示**: 实时显示任务执行进度
- **结果展示**: 以对话形式展示设计结果
- **反馈收集**: 收集用户对结果的反馈

#### 2.2.3 接口定义
```typescript
interface ChatInterface {
  // 发送消息
  sendMessage(message: string, sessionId?: string): Promise<ChatResponse>
  
  // 获取对话历史
  getChatHistory(sessionId: string): Promise<ChatMessage[]>
  
  // 获取任务状态
  getTaskStatus(sessionId: string): Promise<TaskStatus>
  
  // 提供反馈
  provideFeedback(sessionId: string, feedback: Feedback): Promise<void>
}
```

## 3. 核心业务模块

### 3.1 需求分析模块

#### 3.1.1 模块职责
- 解析和理解用户的设计需求
- 识别设计任务的类型和复杂度
- 提取关键设计参数和约束条件
- 生成结构化的需求描述

#### 3.1.2 核心功能
- **需求解析**: 从自然语言中提取设计要求
- **意图识别**: 识别用户的设计意图和目标
- **参数提取**: 提取设计相关的参数和约束
- **需求验证**: 验证需求的完整性和可行性
- **需求补全**: 基于经验补全缺失的需求信息

#### 3.1.3 接口定义
```typescript
interface RequirementAnalyzer {
  // 分析需求
  analyzeRequirement(input: string): Promise<RequirementAnalysis>
  
  // 验证需求
  validateRequirement(requirement: RequirementAnalysis): Promise<ValidationResult>
  
  // 补全需求
  completeRequirement(requirement: RequirementAnalysis): Promise<RequirementAnalysis>
  
  // 获取建议
  getSuggestions(requirement: RequirementAnalysis): Promise<string[]>
}
```

### 3.2 任务管理模块

#### 3.2.1 模块职责
- 将设计需求分解为具体的执行任务
- 管理任务的执行顺序和依赖关系
- 分配合适的工具和资源给每个任务
- 监控任务执行状态和进度

#### 3.2.2 核心功能
- **任务分解**: 将复杂需求分解为可执行的子任务
- **依赖管理**: 管理任务间的依赖关系
- **资源分配**: 为任务分配合适的工具和模型
- **执行调度**: 按照依赖关系调度任务执行
- **进度跟踪**: 实时跟踪任务执行进度

#### 3.2.3 接口定义
```typescript
interface TaskManager {
  // 创建任务列表
  createTaskList(requirement: RequirementAnalysis): Promise<TaskList>
  
  // 执行任务
  executeTask(taskId: string): Promise<TaskResult>
  
  // 获取任务状态
  getTaskStatus(taskId: string): Promise<TaskStatus>
  
  // 更新任务
  updateTask(taskId: string, updates: TaskUpdate): Promise<void>
  
  // 获取任务列表
  getTaskList(sessionId: string): Promise<TaskList>
}
```

### 3.3 设计执行模块

#### 3.3.1 模块职责
- 执行具体的设计任务
- 调用相应的AI模型和工具
- 处理设计过程中的异常情况
- 生成设计结果和中间产物

#### 3.3.2 核心功能
- **器形设计**: 调用相关模型生成产品外形
- **花纸设计**: 生成装饰图案和纹理
- **材质选择**: 选择合适的材质和质感
- **花纸贴合**: 将图案应用到器形上
- **产品渲染**: 生成最终的产品效果图

#### 3.3.3 接口定义
```typescript
interface DesignExecutor {
  // 器形设计
  designShape(parameters: ShapeParameters): Promise<ShapeResult>
  
  // 花纸设计
  designPattern(parameters: PatternParameters): Promise<PatternResult>
  
  // 材质选择
  selectMaterial(parameters: MaterialParameters): Promise<MaterialResult>
  
  // 花纸贴合
  applyPattern(shape: ShapeResult, pattern: PatternResult): Promise<ApplyResult>
  
  // 产品渲染
  renderProduct(designData: DesignData): Promise<RenderResult>
}
```

### 3.4 质量控制模块

#### 3.4.1 模块职责
- 评估设计结果的质量
- 识别设计中的问题和不足
- 生成优化建议和改进方案
- 支持迭代优化流程

#### 3.4.2 核心功能
- **质量评估**: 基于多维度评估设计质量
- **问题识别**: 自动识别设计中的问题
- **优化建议**: 生成具体的优化建议
- **方案对比**: 对比不同设计方案的优劣
- **迭代管理**: 管理设计的迭代优化过程

#### 3.4.3 接口定义
```typescript
interface QualityController {
  // 评估质量
  evaluateQuality(designResult: DesignResult): Promise<QualityScore>
  
  // 识别问题
  identifyIssues(designResult: DesignResult): Promise<Issue[]>
  
  // 生成优化建议
  generateOptimizations(issues: Issue[]): Promise<Optimization[]>
  
  // 对比方案
  compareDesigns(designs: DesignResult[]): Promise<ComparisonResult>
}
```

## 4. MCP服务模块

### 4.1 LiblibAI MCP服务

#### 4.1.1 模块职责
- 封装LiblibAI API调用
- 管理API密钥和签名
- 处理图像生成请求
- 监控生成进度和结果

#### 4.1.2 核心功能
- **文生图**: 基于文本描述生成图像
- **图生图**: 基于参考图像生成新图像
- **模型调用**: 调用不同的AI模型
- **工作流执行**: 执行ComfyUI工作流
- **结果管理**: 管理生成的图像结果

### 4.2 设计工具MCP服务

#### 4.2.1 模块职责
- 封装各种设计工具的调用
- 提供统一的工具调用接口
- 管理工具的配置和参数
- 处理工具执行的异常情况

#### 4.2.2 核心功能
- **工具注册**: 注册新的设计工具
- **参数验证**: 验证工具调用参数
- **执行管理**: 管理工具的执行过程
- **结果处理**: 处理工具的执行结果

## 5. 数据模型

### 5.1 核心数据结构

```typescript
// 设计需求
interface DesignRequirement {
  id: string
  userId: string
  description: string
  type: 'workflow' | 'chat'
  parameters: Record<string, any>
  createdAt: Date
}

// 任务定义
interface Task {
  id: string
  name: string
  type: string
  parameters: Record<string, any>
  dependencies: string[]
  status: 'pending' | 'running' | 'completed' | 'failed'
  result?: any
}

// 设计结果
interface DesignResult {
  id: string
  taskId: string
  type: string
  data: any
  quality: QualityScore
  createdAt: Date
}
```

## 6. 模块间通信

### 6.1 通信协议
- **HTTP/REST**: 前后端通信
- **WebSocket**: 实时状态更新
- **MCP Protocol**: MCP服务通信
- **Message Queue**: 异步任务处理

### 6.2 数据流
```
前端 → API网关 → 业务服务 → MCP服务 → AI模型
     ←         ←           ←         ←
```

## 7. 错误处理

### 7.1 错误分类
- **用户输入错误**: 需求不明确或参数错误
- **系统错误**: 服务不可用或网络异常
- **业务错误**: 设计任务执行失败
- **第三方错误**: AI模型调用失败

### 7.2 错误处理策略
- **重试机制**: 对临时性错误进行重试
- **降级处理**: 在服务不可用时提供备选方案
- **用户提示**: 向用户提供清晰的错误信息
- **日志记录**: 记录详细的错误信息用于排查